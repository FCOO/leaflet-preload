<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="da" style="font-size: 100%">

<head>
    <title>fcoo.dk - leaflet-preload - Demo</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv='x-dns-prefetch-control' content='on'>

    <meta name='copyright' content='FCOO'>
    <meta name='owner' content='FCOO'>

    <!-- <link href="bower_components.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw-src.css"
        integrity="sha512-vJfMKRRm4c4UupyPwGUZI8U651mSzbmmPgR3sdE3LcwBPsdGeARvUM5EcSTg34DK8YIRiIo+oJwNfZPMKEQyug=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="bower_components.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"
        integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="../src/leaflet-preload.js"></script>

</head>

<body>
    <p>
    <div id="preloadstatus">Images: 0/0</div>
    <label for="minzoom">Min zoom for preload</label>
    <input type="number" id="minzoom" name="minzoom" min="1" max="5" value="2">
    <label for="maxzoom">Max zoom for preload</label>
    <input type="number" id="maxzoom" name="maxzoom" min="3" max="10" value="5">
    <button id="preloadbtn" onclick="preload()" disabled>PRELOAD</button>
    <button id="cancelbtn" onclick="cancelPreload()">CANCEL</button>
    </p>
    <div id="map" style="width: 1200px; height: 1000px;"></div>

    <script>
        const map = L.map('map', { crs: L.CRS.EPSG3857 }).setView([56.0, 7.0], 3);
        var now = new Date();
        var then = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());

        var url = 'https://{s}.fcoo.dk/webmap/v2/data/FCOO/WW3/ww3.nsbalt_nested.nc.wms'
            + '?cmap=Hs_m_GBP_12colors_denmark&time=' + then.toISOString();
        var tiles = L.tileLayer.wms(
            url,

            {
                bounds: L.latLngBounds([65.79167175292969, 30.013757705688477], [48.54166793823242, -4.069439888000488]),
                maxZoom: 16,
                subdomains: ['wms01', 'wms02', 'wms03'],
                // crs: L.CRS.EPSG3857,
                tileSize: 512,
                layers: 'u_v_nsbalt,u_v_dkinner',
                format: 'image/png',
                transparent: 'TRUE',
                version: '1.3.0',
                styles: 'plot_method=contourf;legend=Hs_m_GBP_12colors_denmark,plot_method=contourf;legend=Hs_m_GBP_12colors_denmark',
            }).addTo(map);

        map.on('preload:finished', event => console.log("Preload finished, success: " + event.success + " errors: " + event.failed));
        map.on('preload:tilesuccess', imgPreloadHandler);
        map.on('preload:tiledfailed', imgPreloadHandler);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControlFull = new L.Control.Draw({
            draw: {
                polyline: false,
                polygon: false,
                marker: false,
                circle: false,
                circlemarker: false,
                rectangle: true

            },
            edit: {
                featureGroup: drawnItems
            }
        });
        var drawControlEditOnly = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: false
        });
        map.addControl(drawControlFull);

        map.on(L.Draw.Event.CREATED, function (e) {
            var type = e.layerType,
                layer = e.layer;
            document.getElementById("preloadbtn").disabled = false;
            drawnItems.addLayer(e.layer);
            drawControlFull.remove(map);
            drawControlEditOnly.addTo(map)
        });

        map.on(L.Draw.Event.DELETED, function (e) {
            if (drawnItems.getLayers().length === 0) {
                drawControlEditOnly.remove(map);
                drawControlFull.addTo(map);
                document.getElementById("preloadbtn").disabled = true;
            };
        });

        var finished = 0;
        var numTiles = 0;
        var preloadStatus = null;

        function updateProgress() {
            document.getElementById("preloadstatus").innerHTML = "Images: " + finished + "/" + numTiles;
        }

        function imgPreloadHandler(event) {
            finished += 1;
            updateProgress();
        }

        function cancelPreload() {
            if (preloadStatus) {
                preloadStatus.cancel();
            }
        }

        function preload() {
            var minzoom = parseInt(document.getElementById("minzoom").value);
            var maxzoom = parseInt(document.getElementById("maxzoom").value);
            var latLngs = drawnItems.getLayers()[0].getLatLngs();
            let selectedRectangele = L.latLngBounds(latLngs[0], latLngs[2]);
            finished = 0
            preloadStatus = map.preparePreload(minzoom, maxzoom, selectedRectangele);
            numTiles = preloadStatus.numTiles;

            updateProgress();
            if (numTiles > 500) {
                alert("Too many tiles: " + numTiles);
                return;
            }
            console.log("Starting preload");
            preloadStatus.preload();

        }
    </script>

</body>

</html>